name: CI

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: "Run Playwright E2E tests"
        required: false
        default: "false"

permissions:
  contents: read

jobs:
  test-and-build:
    name: Test (unit) + Production build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      # Minimal env to prevent runtime config errors during tests/build.
      PUBLIC_SUPABASE_URL: https://example.supabase.co
      PUBLIC_SUPABASE_ANON_KEY: example-public-anon-key
      SUPABASE_URL: https://example.supabase.co
      SUPABASE_KEY: example-public-anon-key
      SUPABASE_SERVICE_ROLE_KEY: example-service-role-key
      OPENROUTER_API_KEY: ""
      OPENROUTER_DEFAULT_MODEL: openai/gpt-4o-mini
      OPENROUTER_HTTP_REFERER: https://example.com
      OPENROUTER_X_TITLE: 10xdevs-ci
      OPENROUTER_TIMEOUT_MS: "45000"
      DEFAULT_USER_ID: 00000000-0000-0000-0000-000000000000
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Node setup
        uses: ./.github/actions/node-setup

      - name: Run unit tests
        run: npm run test:unit

      - name: Build (production)
        run: npm run build

  e2e:
    name: E2E (Playwright) - optional
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test-and-build
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_e2e == 'true' }}
    env:
      PUBLIC_SUPABASE_URL: https://example.supabase.co
      PUBLIC_SUPABASE_ANON_KEY: example-public-anon-key
      SUPABASE_URL: https://example.supabase.co
      SUPABASE_KEY: example-public-anon-key
      SUPABASE_SERVICE_ROLE_KEY: example-service-role-key
      OPENROUTER_API_KEY: ""
      OPENROUTER_DEFAULT_MODEL: openai/gpt-4o-mini
      OPENROUTER_HTTP_REFERER: https://example.com
      OPENROUTER_X_TITLE: 10xdevs-ci
      OPENROUTER_TIMEOUT_MS: "45000"
      DEFAULT_USER_ID: 00000000-0000-0000-0000-000000000000
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Node setup
        uses: ./.github/actions/node-setup

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload Playwright report (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: |
            playwright-report
            test-results
