name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: pull-request-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Node setup
        uses: ./.github/actions/node-setup

      - name: Lint
        run: npm run lint

  unit-test:
    name: Unit tests (Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint
    env:
      # Minimal env to prevent runtime config errors during tests.
      PUBLIC_SUPABASE_URL: https://example.supabase.co
      PUBLIC_SUPABASE_ANON_KEY: example-public-anon-key
      SUPABASE_URL: https://example.supabase.co
      SUPABASE_SERVICE_ROLE_KEY: example-service-role-key
      OPENROUTER_API_KEY: ""
      OPENROUTER_DEFAULT_MODEL: openai/gpt-5.2
      OPENROUTER_HTTP_REFERER: https://example.com
      OPENROUTER_X_TITLE: 10xdevs-pr
      OPENROUTER_TIMEOUT_MS: "45000"
      DEFAULT_USER_ID: 00000000-0000-0000-0000-000000000000
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Node setup
        uses: ./.github/actions/node-setup

      - name: Run unit tests (with coverage)
        run: npm run test:unit -- --coverage

      - name: Upload unit coverage (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: coverage-unit
          path: |
            coverage/unit

  e2e-test:
    name: E2E tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: lint
    # Avoid running with secrets on forked PRs.
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    environment: integration
    env:
      CI: "true"
      # Collect server-side V8 coverage from the Astro dev server started by Playwright webServer.
      NODE_V8_COVERAGE: coverage/e2e-v8

      # Secrets mapped from .env.example (integration environment).
      PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
      PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_DEFAULT_MODEL: ${{ secrets.OPENROUTER_DEFAULT_MODEL || 'openai/gpt-5.2' }}
      OPENROUTER_HTTP_REFERER: ${{ secrets.OPENROUTER_HTTP_REFERER || 'http://localhost:4321' }}
      OPENROUTER_X_TITLE: ${{ secrets.OPENROUTER_X_TITLE || '10xdevs' }}
      OPENROUTER_TIMEOUT_MS: ${{ secrets.OPENROUTER_TIMEOUT_MS || '45000' }}
      DEFAULT_USER_ID: ${{ secrets.DEFAULT_USER_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Node setup
        uses: ./.github/actions/node-setup

      - name: Install Playwright browsers (from config)
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload E2E coverage (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: coverage-e2e
          path: |
            coverage/e2e-v8

      - name: Upload Playwright report (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: |
            playwright-report
            test-results

  status-comment:
    name: Status comment
    runs-on: ubuntu-latest
    needs: [lint, unit-test, e2e-test]
    if: ${{ github.event_name == 'pull_request' && needs.lint.result == 'success' && needs.unit-test.result == 'success' && needs.e2e-test.result == 'success' }}
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              "âœ… **PR checks passed**",
              "",
              "- **Lint**: success",
              "- **Unit tests**: success (artifact: `coverage-unit`)",
              "- **E2E tests**: success (artifacts: `playwright-report`, `coverage-e2e`)",
              "",
              `Run details: ${runUrl}`,
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
